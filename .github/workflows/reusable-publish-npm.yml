---
name: Reusable npm Publishing Workflow

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '22'
      dist-tag:
        description: 'npm dist-tag (latest, beta, next, etc.)'
        required: false
        type: string
        default: 'latest'
      provenance:
        description: 'Enable npm provenance attestation'
        required: false
        type: boolean
        default: true
      access:
        description: 'Package access level (public, restricted)'
        required: false
        type: string
        default: 'public'
      dry-run:
        description: 'Build and pack only, do not publish'
        required: false
        type: boolean
        default: false
      working-directory:
        description: 'Working directory containing the package'
        required: false
        type: string
        default: '.'
    outputs:
      published:
        description: 'Whether the package was published'
        value: ${{ jobs.publish.outputs.published }}
      version:
        description: 'Published package version'
        value: ${{ jobs.publish.outputs.version }}
      package-name:
        description: 'Published package name'
        value: ${{ jobs.publish.outputs.package-name }}
      tarball:
        description: 'Path to the built tarball'
        value: ${{ jobs.publish.outputs.tarball }}

jobs:
  publish:
    name: Publish to npm
    # CRITICAL: Must use GitHub-hosted runner for provenance attestation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write

    outputs:
      published: ${{ steps.npm.outputs.published || 'false' }}
      version: ${{ steps.npm.outputs.version }}
      package-name: ${{ steps.npm.outputs.package-name }}
      tarball: ${{ steps.npm.outputs.tarball }}

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Publish to npm
        id: npm
        uses: ./.github/actions/publish-npm
        with:
          node-version: ${{ inputs.node-version }}
          dist-tag: ${{ inputs.dist-tag }}
          provenance: ${{ inputs.provenance }}
          access: ${{ inputs.access }}
          dry-run: ${{ inputs.dry-run }}
          working-directory: ${{ inputs.working-directory }}

      - name: Attest build provenance
        if: inputs.dry-run == false && inputs.provenance
        uses: actions/attest-build-provenance@c074443f1aee8d4aeeae555aebba3282517141b2 # v2.2.3
        with:
          subject-path: >-
            ${{ inputs.working-directory }}/${{ steps.npm.outputs.tarball }}

---
name: Reusable PyPI Publishing Workflow

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for building'
        required: false
        type: string
        default: '3.12'
      validate:
        description: 'Run twine check before publishing'
        required: false
        type: boolean
        default: true
      test-pypi:
        description: 'Publish to TestPyPI instead of PyPI'
        required: false
        type: boolean
        default: false
      update-homebrew:
        description: 'Update Homebrew formula after publishing'
        required: false
        type: boolean
        default: false
      homebrew-tap:
        description: 'Homebrew tap repository (owner/repo)'
        required: false
        type: string
        default: ''
      homebrew-formula:
        description: 'Homebrew formula name'
        required: false
        type: string
        default: ''
      dry-run:
        description: 'Build only, do not publish'
        required: false
        type: boolean
        default: false
      working-directory:
        description: 'Working directory containing the package'
        required: false
        type: string
        default: '.'
    outputs:
      published:
        description: 'Whether the package was published'
        value: ${{ jobs.publish.outputs.published }}
      version:
        description: 'Published package version'
        value: ${{ jobs.publish.outputs.version }}
      package-name:
        description: 'Published package name'
        value: ${{ jobs.publish.outputs.package-name }}

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write

    outputs:
      published: ${{ steps.publish.outputs.published || 'false' }}
      version: ${{ steps.build.outputs.version }}
      package-name: ${{ steps.build.outputs.name }}

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install build dependencies
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: uv pip install build twine

      - name: Validate package metadata
        if: inputs.validate
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [[ ! -f "pyproject.toml" ]]; then
            echo "::error::pyproject.toml not found"
            exit 1
          fi

      - name: Build package
        id: build
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: |
          # Clean previous builds
          rm -rf dist/ build/ ./*.egg-info/

          # Build
          uv build

          # Extract metadata
          version=$(grep -E '^version\s*=' pyproject.toml | head -1 | \
            sed 's/.*=\s*["\x27]\([^"\x27]*\)["\x27].*/\1/')
          name=$(grep -E '^name\s*=' pyproject.toml | head -1 | \
            sed 's/.*=\s*["\x27]\([^"\x27]*\)["\x27].*/\1/')

          {
            echo "version=$version"
            echo "name=$name"
          } >> "$GITHUB_OUTPUT"
          echo "Built $name@$version"

      - name: Validate distribution
        if: inputs.validate
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        run: uv run twine check dist/*

      - name: Attest build provenance
        if: inputs.dry-run == false
        uses: actions/attest-build-provenance@c074443f1aee8d4aeeae555aebba3282517141b2 # v2.2.3
        with:
          subject-path: ${{ inputs.working-directory }}/dist/*

      - name: Publish to PyPI
        id: publish
        if: inputs.dry-run == false
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.12.4
        with:
          repository-url: >-
            ${{ inputs.test-pypi && 'https://test.pypi.org/legacy/' ||
            'https://upload.pypi.org/legacy/' }}
          packages-dir: ${{ inputs.working-directory }}/dist/

      - name: Set publish status
        if: inputs.dry-run == false
        shell: bash
        run: echo "published=true" >> "$GITHUB_OUTPUT"

      - name: Generate summary
        shell: bash
        env:
          PACKAGE_NAME: ${{ steps.build.outputs.name }}
          PACKAGE_VERSION: ${{ steps.build.outputs.version }}
          DRY_RUN: ${{ inputs.dry-run }}
          TEST_PYPI: ${{ inputs.test-pypi }}
        run: |
          {
            echo "## PyPI Publishing"
            echo ""
            echo "| Property | Value |"
            echo "| -------- | ----- |"
            echo "| Package | $PACKAGE_NAME |"
            echo "| Version | $PACKAGE_VERSION |"

            if [[ "$TEST_PYPI" == "true" ]]; then
              echo "| Registry | TestPyPI |"
            else
              echo "| Registry | PyPI |"
            fi

            if [[ "$DRY_RUN" == "true" ]]; then
              echo "| Status | :construction: Dry Run |"
            else
              echo "| Status | :white_check_mark: Published |"
              if [[ "$TEST_PYPI" == "true" ]]; then
                url="https://test.pypi.org/project/$PACKAGE_NAME/$PACKAGE_VERSION/"
              else
                url="https://pypi.org/project/$PACKAGE_NAME/$PACKAGE_VERSION/"
              fi
              echo "| URL | $url |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  update-homebrew:
    name: Update Homebrew Formula
    needs: publish
    if: >-
      inputs.update-homebrew && inputs.dry-run == false &&
      needs.publish.outputs.published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Update Homebrew formula
        uses: ./.github/actions/update-homebrew
        with:
          tap-repository: ${{ inputs.homebrew-tap }}
          formula: ${{ inputs.homebrew-formula }}
          package-name: ${{ needs.publish.outputs.package-name }}
          version: ${{ needs.publish.outputs.version }}
          wait-for-availability: 'true'
          test-pypi: ${{ inputs.test-pypi }}

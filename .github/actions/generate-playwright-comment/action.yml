name: 'Generate Playwright Comment'
description: 'Generate a formatted PR comment from Playwright test results'
author: 'lgtm-hq'

inputs:
  results-path:
    description: 'Path to Playwright JSON results file'
    required: false
    default: 'playwright-report/results.json'
  report-url:
    description: 'URL to full Playwright report (e.g., GitHub Pages URL)'
    required: false
    default: ''
  show-failed-tests:
    description: 'Show list of failed tests in comment'
    required: false
    default: 'true'
  max-failed-tests:
    description: 'Maximum number of failed tests to show'
    required: false
    default: '10'

outputs:
  comment-body:
    description: 'Generated comment body in Markdown'
    value: ${{ steps.generate.outputs.body }}
  total-tests:
    description: 'Total number of tests'
    value: ${{ steps.generate.outputs.total }}
  passed-tests:
    description: 'Number of passed tests'
    value: ${{ steps.generate.outputs.passed }}
  failed-tests:
    description: 'Number of failed tests'
    value: ${{ steps.generate.outputs.failed }}
  skipped-tests:
    description: 'Number of skipped tests'
    value: ${{ steps.generate.outputs.skipped }}
  success:
    description: 'Whether all tests passed'
    value: ${{ steps.generate.outputs.success }}

runs:
  using: 'composite'
  steps:
    - name: Generate comment
      id: generate
      shell: bash
      run: |
        RESULTS_PATH="${{ inputs['results-path'] }}"
        REPORT_URL="${{ inputs['report-url'] }}"
        SHOW_FAILED="${{ inputs['show-failed-tests'] }}"
        MAX_FAILED="${{ inputs['max-failed-tests'] }}"

        # Check if results file exists
        if [[ ! -f "$RESULTS_PATH" ]]; then
          echo "::warning::Playwright results not found at $RESULTS_PATH"
          echo "body=## Playwright Results\n\nâš ï¸ No test results found" >> "$GITHUB_OUTPUT"
          echo "total=0" >> "$GITHUB_OUTPUT"
          echo "passed=0" >> "$GITHUB_OUTPUT"
          echo "failed=0" >> "$GITHUB_OUTPUT"
          echo "skipped=0" >> "$GITHUB_OUTPUT"
          echo "success=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        # Extract test counts from Playwright JSON report
        # Handle different Playwright report formats
        if jq -e '.stats' "$RESULTS_PATH" > /dev/null 2>&1; then
          # Standard report format
          TOTAL=$(jq -r '.stats.expected + .stats.unexpected + .stats.flaky + .stats.skipped // 0' "$RESULTS_PATH")
          PASSED=$(jq -r '.stats.expected // 0' "$RESULTS_PATH")
          FAILED=$(jq -r '.stats.unexpected // 0' "$RESULTS_PATH")
          SKIPPED=$(jq -r '.stats.skipped // 0' "$RESULTS_PATH")
          FLAKY=$(jq -r '.stats.flaky // 0' "$RESULTS_PATH")
          DURATION=$(jq -r '.stats.duration // 0' "$RESULTS_PATH")
        else
          # Fallback: count from suites
          TOTAL=$(jq '[.. | .tests? // [] | .[]] | length' "$RESULTS_PATH" 2>/dev/null || echo "0")
          PASSED=$(jq '[.. | .tests? // [] | .[] | select(.status == "passed")] | length' "$RESULTS_PATH" 2>/dev/null || echo "0")
          FAILED=$(jq '[.. | .tests? // [] | .[] | select(.status == "failed")] | length' "$RESULTS_PATH" 2>/dev/null || echo "0")
          SKIPPED=$(jq '[.. | .tests? // [] | .[] | select(.status == "skipped")] | length' "$RESULTS_PATH" 2>/dev/null || echo "0")
          FLAKY=0
          DURATION=0
        fi

        echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
        echo "passed=$PASSED" >> "$GITHUB_OUTPUT"
        echo "failed=$FAILED" >> "$GITHUB_OUTPUT"
        echo "skipped=$SKIPPED" >> "$GITHUB_OUTPUT"

        SUCCESS="true"
        [[ $FAILED -gt 0 ]] && SUCCESS="false"
        echo "success=$SUCCESS" >> "$GITHUB_OUTPUT"

        # Calculate pass rate
        if [[ $TOTAL -gt 0 ]]; then
          PASS_RATE=$(( (PASSED * 100) / TOTAL ))
        else
          PASS_RATE=0
        fi

        # Format duration
        if [[ $DURATION -gt 0 ]]; then
          DURATION_SEC=$(( DURATION / 1000 ))
          DURATION_STR="${DURATION_SEC}s"
        else
          DURATION_STR="N/A"
        fi

        # Status emoji
        if [[ "$SUCCESS" == "true" ]]; then
          STATUS_EMOJI="âœ…"
          STATUS_TEXT="All tests passed"
        else
          STATUS_EMOJI="âŒ"
          STATUS_TEXT="${FAILED} test(s) failed"
        fi

        # Generate comment body
        BODY="## Playwright Test Results

        ${STATUS_EMOJI} **${STATUS_TEXT}**

        | Metric | Count |
        |--------|-------|
        | Total | ${TOTAL} |
        | âœ… Passed | ${PASSED} |
        | âŒ Failed | ${FAILED} |
        | â­ï¸ Skipped | ${SKIPPED} |
        | ðŸ”„ Flaky | ${FLAKY:-0} |
        | â±ï¸ Duration | ${DURATION_STR} |
        | ðŸ“Š Pass Rate | ${PASS_RATE}% |"

        # Add failed tests list
        if [[ "$SHOW_FAILED" == "true" && $FAILED -gt 0 ]]; then
          FAILED_TESTS=$(jq -r "[.. | .tests? // [] | .[] | select(.status == \"failed\") | .title] | .[0:${MAX_FAILED}] | .[]" "$RESULTS_PATH" 2>/dev/null || echo "")
          if [[ -n "$FAILED_TESTS" ]]; then
            BODY="${BODY}

        <details>
        <summary>Failed Tests (showing up to ${MAX_FAILED})</summary>

        \`\`\`
        ${FAILED_TESTS}
        \`\`\`

        </details>"
          fi
        fi

        if [[ -n "$REPORT_URL" ]]; then
          BODY="${BODY}

        [View Full Report](${REPORT_URL})"
        fi

        # Output body (handle multiline)
        EOF_MARKER="EOF_$(date +%s)"
        echo "body<<$EOF_MARKER" >> "$GITHUB_OUTPUT"
        echo "$BODY" >> "$GITHUB_OUTPUT"
        echo "$EOF_MARKER" >> "$GITHUB_OUTPUT"

branding:
  icon: 'play-circle'
  color: 'green'
